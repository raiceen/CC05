<!DOCTYPE html>
<html>
<head>
    <title>IoT Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .stats { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { flex: 1; padding: 20px; background: #f0f0f0; border-radius: 8px; text-align: center; }
        .temp-card { border-top: 4px solid #ff6b6b; }
        .humidity-card { border-top: 4px solid #4dabf7; }
        .prediction-card { border-top: 4px solid #51cf66; }
        .chart-container { height: 400px; margin-bottom: 30px; border: 1px solid #eee; padding: 15px; }
        .stat-value { font-size: 2.5rem; font-weight: bold; }
        .temp-value { color: #ff6b6b; }
        .humidity-value { color: #4dabf7; }
        .prediction-value { color: #51cf66; }
        .threshold-control { margin: 20px 0; padding: 15px; background: #f8f8f8; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>IoT Sensor Dashboard</h1>
        <p>Real-time Monitoring System</p>
    </div>

    <div class="stats">
        <div class="stat-card temp-card">
            <h3>Current Temperature</h3>
            <div class="stat-value temp-value" id="currentTemp">-- °C</div>
        </div>

        <div class="stat-card humidity-card">
            <h3>Current Humidity</h3>
            <div class="stat-value humidity-value" id="currentHumidity">-- %</div>
        </div>

        <div class="stat-card prediction-card">
            <h3>Temperature Prediction</h3>
            <div class="stat-value prediction-value" id="predictionValue">-- °C</div>
            <div id="predictionMessage"></div>
        </div>
    </div>

    <div class="threshold-control">
        <h3>Temperature Alert Threshold</h3>
        <input type="number" id="thresholdInput" value="30">
        <button onclick="setThreshold()">Set Threshold</button>
    </div>

    <div class="chart-container">
        <canvas id="temperatureChart"></canvas>
    </div>

    <div class="chart-container">
        <canvas id="humidityChart"></canvas>
    </div>

    <div style="text-align: center; margin-top: 30px; color: #666;">
        Last updated: <span id="lastUpdated">Never</span>
    </div>

    <div style="position: fixed; top: 10px; right: 10px; background: green; color: white; padding: 5px; z-index: 1000;" id="ci-cd-test">
        Deployment Test
    </div>

    <script>
    // use relative paths so we always stay on the same origin & protocol
        const API_BASE = "";
        const DATA_API = "/data";
        const PREDICT_API = "/predict";
        const SET_THRESHOLD_API = "/set-threshold";

        let tempChart, humidityChart;
        let lastUpdateTime = null;

        function initCharts() {
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            tempChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Temperature (°C)'
                            }
                        }
                    }
                }
            });

            const humidityCtx = document.getElementById('humidityChart').getContext('2d');
            humidityChart = new Chart(humidityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: '#4dabf7',
                        backgroundColor: 'rgba(77, 171, 247, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Humidity (%)'
                            }
                        }
                    }
                }
            });
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString();
        }

        async function updateDashboard() {
            try {
                console.log("Fetching sensor data...");

                // Get sensor data
                const response = await fetch(DATA_API);

                if (!response.ok) {
                    throw new Error(`Failed to fetch data: ${response.status}`);
                }

                const sensorData = await response.json();
                console.log("Received sensor data:", sensorData);

                // Update current readings
                if (sensorData.length > 0) {
                    const lastEntry = sensorData[sensorData.length - 1];
                    document.getElementById('currentTemp').textContent = `${lastEntry.temperature} °C`;
                    document.getElementById('currentHumidity').textContent = `${lastEntry.humidity} %`;
                }

                // Update charts
                const labels = sensorData.map(d => formatTime(d.timestamp));
                tempChart.data.labels = labels;
                tempChart.data.datasets[0].data = sensorData.map(d => d.temperature);
                tempChart.update();

                humidityChart.data.labels = labels;
                humidityChart.data.datasets[0].data = sensorData.map(d => d.humidity);
                humidityChart.update();

                // Get prediction
                console.log("Fetching prediction...");
                const predictionResponse = await fetch(PREDICT_API);

                if (!predictionResponse.ok) {
                    throw new Error(`Failed to fetch prediction: ${predictionResponse.status}`);
                }

                const prediction = await predictionResponse.json();
                console.log("Received prediction:", prediction);

                document.getElementById('predictionValue').textContent = `${prediction.prediction} °C`;
                document.getElementById('predictionMessage').textContent = prediction.message;

                // Update timestamp
                lastUpdateTime = new Date();
                document.getElementById('lastUpdated').textContent = lastUpdateTime.toLocaleTimeString();

            } catch (error) {
                console.error("Dashboard error:", error);
                document.getElementById('predictionMessage').textContent = "Error loading data";

                // Update timestamp with error
                document.getElementById('lastUpdated').textContent = `Error: ${error.message}`;
            }
        }

        function setThreshold() {
            const threshold = document.getElementById('thresholdInput').value;
            console.log("Setting threshold to:", threshold);

            fetch(SET_THRESHOLD_API, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ temperature: threshold })
            })
            .then(response => {
                if (response.ok) {
                    console.log("Threshold set successfully");
                } else {
                    console.error("Failed to set threshold:", response.status);
                }
            })
            .catch(error => {
                console.error("Error setting threshold:", error);
            });
        }

        // Initialize dashboard
        window.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateDashboard();

            // Update every 60 seconds
            setInterval(updateDashboard, 60000);
        });
    </script>
</body>
</html>